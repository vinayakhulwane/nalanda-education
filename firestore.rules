/**
 * # Firestore Security Rules
 *
 * ## Core Philosophy
 * This ruleset enforces a strict user-ownership model. All user data is private and stored in a document that can only be accessed by the authenticated user who owns it. The default security posture is to deny all access unless explicitly granted.
 */
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================
    // 1. HELPER FUNCTIONS
    // ==========================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isRole(role) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    function isTeacher() {
      return isRole('teacher');
    }

    function isAdmin() {
      return isRole('admin');
    }

    function hasValidAndConsistentUserDataOnCreate(userId) {
      return request.resource.data.id == userId;
    }

    function hasImmutableUserDataOnUpdate() {
      let incomingData = request.resource.data;
      let existingData = resource.data;
      return incomingData.id == existingData.id;
    }

    /**
     * Checks if the only field being updated is 'rewardsClaimed' from false to true.
     * This prevents any other modification to the historical attempt data.
     */
    function isClaimingRewards() {
      // The update request should only contain the 'rewardsClaimed' field.
      // size() == 1 means only one field is being changed.
      return request.resource.data.diff(resource.data).affectedKeys().hasOnly(['rewardsClaimed']) &&
             request.resource.data.rewardsClaimed == true &&
             resource.data.rewardsClaimed == false;
    }


    // ==========================================
    // 2. COLLECTION RULES
    // ==========================================

    /**
     * Users Collection
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) && hasValidAndConsistentUserDataOnCreate(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isExistingOwner(userId);
    }
     
    // Static Metadata Collections
    match /classes/{classId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /subjects/{subjectId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /units/{unitId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /categories/{categoryId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * Questions Collection
     * ✅ Teachers must be able to write here
     */
    match /questions/{questionId} {
      allow read: if isSignedIn();
      allow write: if isTeacher() || isAdmin();
    }

    /**
     * Worksheets Collection
     */
    match /worksheets/{worksheetId} {
      // Read: Author can read own, Admins can read all, Signed in users can read.
      allow get: if isOwner(resource.data.authorId) || isAdmin() || isSignedIn();
      
      // List: Admins can see all. Users can list if filtering by authorId or subjectId
      allow list: if isAdmin() ||
                     (request.query.keys().hasOnly(['authorId', 'subjectId', 'orderBy'])) ||
                      (request.query.keys().hasAny(['authorId', 'subjectId'])) && isSignedIn();
      
      // Create: 
      // - Teachers/Admins can create any type.
      // - Students can ONLY create 'practice' worksheets for themselves.
      allow create: if (isTeacher() || isAdmin()) ||
                       (request.resource.data.worksheetType == 'practice' && isOwner(request.resource.data.authorId));

      // Update & Delete: Only Teachers and Admins can modify existing worksheets.
      allow update, delete: if isTeacher() || isAdmin();
    }

    /**
     * Worksheet Attempts
     * ✅ Renamed from /attempts to match your App Code
     */
    match /worksheet_attempts/{attemptId} {
      // 1. Create: Must match the user's ID
      allow create: if isOwner(request.resource.data.userId);

      // 2. Read (Get & List): 
      // - Students can see ONLY their own data
      // - Teachers/Admins can see everything.
      allow read: if isOwner(resource.data.userId) || isTeacher() || isAdmin();
      allow list: if (request.query.keys().hasOnly(['userId', 'worksheetId', 'limit', 'orderBy', 'attemptedAt']) && request.query.userId == request.auth.uid) || isTeacher() || isAdmin();

      // 3. Update is allowed ONLY to claim rewards. No other changes permitted.
      allow update: if isOwner(resource.data.userId) && isClaimingRewards();
      allow delete: if false; // Deleting history is not allowed.
    }

    /**
     * Global Settings
     */
    match /settings/{settingId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }

    match /transactions/{transactionId} {
      // A user can create their own transactions.
      allow create: if isOwner(request.resource.data.userId);
      
      // A user can only list/read their own transactions.
      allow get: if isOwner(resource.data.userId) || isAdmin();
      allow list: if request.query.keys().hasOnly(['userId', 'orderBy']) &&
                   request.query.userId == request.auth.uid;

      // Transactions are immutable.
      allow update, delete: if false;
    }
  }
}
