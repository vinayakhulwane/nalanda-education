/**
 * # Firestore Security Rules
 *
 * ## Core Philosophy
 * This ruleset enforces a strict user-ownership model. All user data is private and stored in a document that can only be accessed by the authenticated user who owns it. The default security posture is to deny all access unless explicitly granted.
 */
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ==========================================
    // 1. HELPER FUNCTIONS
    // ==========================================

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    function isRole(role) {
      return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    function isTeacher() {
      return isRole('teacher');
    }

    function isAdmin() {
      return isRole('admin');
    }

    function hasValidAndConsistentUserDataOnCreate(userId) {
      return request.resource.data.id == userId;
    }

    function hasImmutableUserDataOnUpdate() {
      let incomingData = request.resource.data;
      let existingData = resource.data;
      return incomingData.id == existingData.id;
    }


    // ==========================================
    // 2. COLLECTION RULES
    // ==========================================

    /**
     * Users Collection
     */
    match /users/{userId} {
      allow get: if isOwner(userId) || isAdmin();
      allow list: if isAdmin();
      allow create: if isOwner(userId) && hasValidAndConsistentUserDataOnCreate(userId);
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isExistingOwner(userId);
    }
     
    // Static Metadata Collections
    match /classes/{classId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /subjects/{subjectId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /units/{unitId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    match /categories/{categoryId} {
      allow read: if isSignedIn();
      allow write: if isAdmin();
    }

    /**
     * Questions Collection
     * ✅ Teachers must be able to write here
     */
    match /questions/{questionId} {
      allow read: if isSignedIn();
      allow write: if isTeacher() || isAdmin();
    }

    /**
     * Worksheets Collection
     */
    match /worksheets/{worksheetId} {
      // Read: Author can read own, Admins can read all, Signed in users can read.
      allow get: if isOwner(resource.data.authorId) || isAdmin() || isSignedIn();
      
      // List: Users can list if filtering by authorId or subjectId
      allow list: if (request.query.keys().hasOnly(['authorId', 'subjectId', 'orderBy'])) ||
                      (request.query.keys().hasAny(['authorId', 'subjectId'])) && isSignedIn();
      
      // Write: Teachers and Admins
      allow write: if isTeacher() || isAdmin();
    }

    /**
     * Worksheet Attempts
     * ✅ Renamed from /attempts to match your App Code
     */
    match /worksheet_attempts/{attemptId} {
      // 1. Create: Must match the user's ID
      allow create: if isOwner(request.resource.data.userId);

      // 2. Read (Get & List): 
      // - Students can see ONLY their own data (resource.data.userId matches auth.uid)
      // - Teachers/Admins can see everything.
      // NOTE: Your React code MUST use .where('userId', '==', user.uid) for students.
      allow read: if isOwner(resource.data.userId) || isTeacher() || isAdmin();

      // 3. No updates or deletes allowed (History is permanent)
      allow update, delete: if false;
    }

    /**
     * Global Settings
     */
    match /settings/{settingId} {
        allow read: if isSignedIn();
        allow write: if isAdmin();
    }
  }
}